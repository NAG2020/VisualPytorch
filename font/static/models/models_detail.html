<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="../../resources/templatesRes/img/favicon.ico">
    <!-- Place favicon.ico in the root directory -->
    <!-- Google Fonts -->
    <link href='https://fonts.googleapis.com/css?family=Poppins:400,700,600,500,300' rel='stylesheet' type='text/css'>

    <!-- all css here -->
<!-- bootstrap v3.3.6 css -->
<!--<link rel="stylesheet" href="https://www.jq22.com/jquery/bootstrap-3.3.4.css">-->

<link rel="stylesheet" href="../../resources/bootstrap.min.css">
<!-- animate css -->
<link rel="stylesheet" href="../../resources/templatesRes/css/animate.css">
<!-- jquery-ui.min css -->
<link rel="stylesheet" href="../../resources/templatesRes/css/jquery-ui.min.css">
<!-- meanmenu css -->
<link rel="stylesheet" href="../../resources/templatesRes/css/meanmenu.min.css">
<!-- Font-Awesome css -->
<link rel="stylesheet" href="../../resources/templatesRes/css/font-awesome.min.css">
<!-- pe-icon-7-stroke css -->
<link rel="stylesheet" href="../../resources/templatesRes/css/pe-icon-7-stroke.css">
<!-- Flaticon css -->
<link rel="stylesheet" href="../../resources/templatesRes/css/flaticon.css">
<!-- venobox css -->
<link rel="stylesheet" href="../../resources/templatesRes/venobox/venobox.css " type="text/css" media="screen" />
<!-- nivo slider css -->
<link rel="stylesheet" href="../../resources/templatesRes/lib/css/nivo-slider.css " type="text/css" />
<link rel="stylesheet" href="../../resources/templatesRes/lib/css/preview.css " type="text/css" media="screen" />
<!-- owl.carousel css -->
<link rel="stylesheet" href="../../resources/templatesRes/css/owl.carousel.css">
<!-- style css -->
<link rel="stylesheet" href="../../resources/templatesRes/css/style.css">
<!-- responsive css -->
<link rel="stylesheet" href="../../resources/templatesRes/css/responsive.css">
<!--原有head-->
    <meta charset="UTF-8">
    <title>VisualPytorch</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <script type="text/javascript" src="../../resources/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="../../resources/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../resources/jquery-ui.js"></script>
    <link href="../../resources/bootstrap.min.css" rel="stylesheet">
    <link href="../../resources/jquery-ui.css" rel="stylesheet">
    <link href="../../resources/jquery-ui.structure.css" rel="stylesheet">
    <link href="../../resources/jquery-ui.theme.css" rel="stylesheet">
    <link href="../../css/layer.css" rel="stylesheet">
    <link href="../../css/buttons.css" rel="stylesheet">
    <script type="text/javascript" src="../../resources/jsplumb.min.js"></script>
    <script type="text/javascript" src="../../javascript/graph_action.js"></script>
    <script type="text/javascript" src="../../javascript/layer_form.js"></script>
    <script type="text/javascript" src="../../javascript/base_service.js"></script>
</head>

<body>
    <nav id="header"></nav>
    <script>
        $("#header").load("../base/header.html");
    </script>
    <!--解决在ie火狐浏览器等中不兼容出现布局错误的问题，暂时性解决方案-->
    <div class="single-product-area section-padding">
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-sm-7" id="canvas">
                    <div style="height:550px;border:0.5px solid black">
                    </div>
                </div>
                <div class="col-md-6 col-sm-5">       
                    <div class="panel-group" id="left_ele_collapse" style="margin-top: 20px; display: none;">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4 class="panel-title">
                                    <a data-toggle="collapse" data-parent="#left_ele_collapse"
                                       href="#collapseOne">
                                        可选用网络层
                                    </a>
                                </h4>
                            </div>
                            <div id="collapseOne" class="panel-collapse collapse in">
        
                                <div class="panel-body">
                                    <div class="ele_in_list">
                                        <div class="node node_little start little_green" id="start">
                                            开始
                                        </div>
                                    </div>
                                    <div class="ele_in_list">
                                        <div class="node node_little lightblue" id="view_layer" type="button"
                                             data-container="body" data-toggle="popover">
                                            reshape层
                                        </div>
                                    </div>
                                    <div class="ele_in_list">
                                        <div class="node node_little lightblue" id="linear_layer" type="button"
                                             data-container="body" data-toggle="popover" in_channel="" out_channel="">
                                            全连接层
                                        </div>
                                    </div>
        
                                    <div class="ele_in_list">
                                        <div class="node node_little lightblue" id="conv1d_layer" type="button"
                                             data-container="body" data-toggle="popover">
                                            一维卷积层
                                        </div>
                                    </div>
        
                                    <div class="ele_in_list">
                                        <div class="node node_little lightblue" id="conv2d_layer" type="button"
                                             data-container="body" data-toggle="popover">
                                            二维卷积层
                                        </div>
                                    </div>
        
                                    <div class="ele_in_list">
                                        <div class="node node_little lightblue" id="element_wise_add_layer" type="button"
                                             data-container="body" data-toggle="popover">
                                            元素级相加层
                                        </div>
                                    </div>
        
                                    <div class="ele_in_list">
                                        <div class="node node_little lightblue" id="concatenate_layer" type="button"
                                             data-container="body" data-toggle="popover">
                                            channel维度拼接层
                                        </div>
                                    </div>
        
                                </div>
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4 class="panel-title">
                                    <a data-toggle="collapse" data-parent="#left_ele_collapse"
                                       href="#collapseTwo">
                                        elements_group_2
                                    </a>
                                </h4>
                            </div>
                            <div id="collapseTwo" class="panel-collapse collapse">
                                <div class="panel-body">
                                </div>
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4 class="panel-title">
                                    <a data-toggle="collapse" data-parent="#left_ele_collapse"
                                       href="#collapseThree">
                                        elements_group_3
                                    </a>
                                </h4>
                            </div>
                            <div id="collapseThree" class="panel-collapse collapse">
                                <div class="panel-body">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="single-product-details">
                        <div style="margin-top:20px">
                            <form class="form-horizontal" role="form">
                                <h2 id="model_name">模型的名字</h2>
                                <div class="form-group">
                                    <label class="col-sm-6 control-label">epoch(训练轮次)</label>
                                    <div class="col-sm-5">
                                        <input type="text" class="form-control" placeholder="1" id="epoch">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-6 control-label">optimizer(优化器)</label>
                                    <div class="col-sm-5">
                                        <select id="optimizer" class="form-control">
                                            <option value="torch.optim.Adam">Adam</option>
                                            <option value="torch.optim.Optimizer">Optimizer</option>
                                            <option value="torch.optim.Adamax">Adamax</option>
                                            <option value="torch.optim.ASGD">ASGD</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-6 control-label">learning_rate(学习率)</label>
                                    <div class="col-sm-5">
                                        <input type="text" id="learning_rate" class="form-control" placeholder="0.5">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-6 control-label">batch_size</label>
                                    <div class="col-sm-5">
                                        <input type="text" id="batch_size" class="form-control" placeholder="1">
                                    </div>
                                </div>
            
                            </form>
                        </div>
                        <div class="product-attributes clearfix" style="text-align:center">
                           <span>
                           <a class="cart-btn btn-default" id="modify">
                                    <i class="flaticon-arrows-1"></i>
                                    编辑此模型
                                </a>
                           </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav id="footer"></nav>
    <script>
        $("#footer").load("../base/footer.html");
    </script>
</body>

<script>
    var my_end_point = {
        endpoint: ["Dot", {radius: 5}],
        connectorStyle: {
            stroke: "#cccccc",
            strokeWidth: 3,

        },
        isSource: true,
        isTarget: true,
        maxConnections: -1,
        connector: ["Flowchart", {stub: [40, 60], gap: 5, cornerRadius: 5, alwaysRespectStubs: true}],
        connectorOverlays: [["Arrow", {width: 10, length: 10, location: 1}]],
        connectionsDetachable: true,

    };
</script>

<script>
    var canvas_cnt = 0;
    // $("#view_layer").draggable(
    //     {
    //         helper: "clone",
    //         scope: "ss",
    //     }
    // );
    // $("#linear_layer").draggable(
    //     {
    //         helper: "clone",
    //         scope: "ss",
    //     }
    // );
    // $("#conv1d_layer").draggable(
    //     {
    //         helper: "clone",
    //         scope: "ss",
    //     }
    // );
    // $("#conv2d_layer").draggable(
    //     {
    //         helper: "clone",
    //         scope: "ss",
    //     }
    // );
    // $("#element_wise_add_layer").draggable(
    //     {
    //         helper: "clone",
    //         scope: "ss",
    //     }
    // );
    // $("#concatenate_layer").draggable(
    //     {
    //         helper: "clone",
    //         scope: "ss",
    //     }
    // );
    // $("#start").draggable(
    //     {
    //         helper: "clone",
    //         scope: "ss",
    //     }
    // );

    var no_popover = ["start", "element_wise_add_layer"];

    $("#canvas").droppable({
        scope: "ss",
        drop: function (event, ui) {
            var left = parseInt(ui.offset.left - $("#canvas").offset().left);
            var top = parseInt(ui.offset.top - $("#canvas").offset().top);
            var name = ui.draggable[0].id;
            canvas_cnt++;
            var id = "canvas_" + canvas_cnt;
            if (ui.hasOwnProperty('id')) {
                id = ui['id'];
            }
            /*$(this).append("<div class='" + $("#" + name).attr("class") + "' id='" + id + "' name='" + name + "' type='" + $("#" + name).attr("type") + "' " +
                "onclick='popover_show(\"" + id + "\",\"" + name + "\")'" + " data-container='" + $("#" + name).attr("data-container") + "' data-toggle='" + $("#" + name).attr("data-toggle") + "' " + ">" + $(ui.helper).html() + "</div>");*/
            $("#canvas").append("<div class='" + $("#" + name).attr("class") + "' id='" + id + "' name='" + name + "' type='" + $("#" + name).attr("type") + "' " +
                " data-container='" + $("#" + name).attr("data-container") + "' data-toggle='" + $("#" + name).attr("data-toggle") + "' " + ">" + ui.draggable[0].innerHTML + "</div>");
            $("#" + id).css("left", left).css("top", top);
            //jsPlumb.draggable(id);
            //$("#" + id).draggable({containment: "parent"});
            // jsPlumb.addEndpoint(id, {anchor: 'Top'}, my_end_point);
            // jsPlumb.addEndpoint(id, {anchor: 'Left'}, my_end_point);
            // jsPlumb.addEndpoint(id, {anchor: 'Right'}, my_end_point);
            // jsPlumb.addEndpoint(id, {anchor: 'Bottom'}, my_end_point);
            /*doubleclick("#" + id);*/
            /*$("#" + id).on("click", function () {
                if (confirm("确定要删除吗?")) {
                    jsPlumb.removeAllEndpoints($(this).attr("id"));
                    $(this).remove();
                }
            });*/
            if (name == "start") {
                window.sessionStorage.setItem(id, "{\"start\":\"true\"}");
            }
            if (name == "element_wise_add_layer") {
                window.sessionStorage.setItem(id, "{\"element_wise_add_layer\":\"true\"}");
            }
            if (name == "view_layer") {
                window.sessionStorage.setItem(id, "{\"shape\":\"1\"}");
            }
            if (name == "concatenate_layer") {
                window.sessionStorage.setItem(id, "{\"dim\":\"1\"}");
            }
            if (name == "linear_layer") {
                window.sessionStorage.setItem(id, "{\"in_channels\":\"1\",\"out_channels\":\"1\"}");
            }
            if (name == "conv1d_layer") {
                window.sessionStorage.setItem(id, "{\"in_channels\":\"1\",\"out_channels\":\"1\",\"kernel_size\":\"1\",\"stride\":\"1\",\"padding\":\"0\",\"activity\":\"None\",\"pool_way\":\"None\",\"pool_kernel_size\":\"\",\"pool_stride\":\"\",\"pool_padding\":\"0\"}");
            }
            if (name == "conv2d_layer") {
                window.sessionStorage.setItem(id, "{\"in_channels\":\"1\",\"out_channels\":\"1\",\"kernel_size\":\"1\",\"stride\":\"1\",\"padding\":\"0\",\"activity\":\"None\",\"pool_way\":\"None\",\"pool_kernel_size\":\"\",\"pool_stride\":\"\",\"pool_padding\":\"0\"}");
            }
            $("#" + id).bind("contextmenu", function () {
                return false;
            });
            /*$("#" + id).mousedown(function (e) {
                //右键为3

                if (3 == e.which) {

                    if (confirm("确定要删除吗?")) {
                        jsPlumb.removeAllEndpoints($(this).attr("id"));
                        $(this).remove();

                    }
                }
            });*/

            var has_move = false;
            var has_down = false;

                $("#" + id).bind({
                    mousedown: function (e) {
                        has_move = false;
                        has_down = true;
                        return;
                    },
                    mousemove: function (e) {
                        has_move = true;
                        return;
                    },
                    mouseup: function (e) {
                        if (!has_move) {
                            if (window.sessionStorage.hasOwnProperty("active_node")) {
                                $("#" + window.sessionStorage.getItem("active_node")).removeClass("selected");
                            }
                            window.sessionStorage.setItem("active_node", id);
                            $("#" + id).addClass("selected");

                            show_form(id, name);
                        }
                        has_move = false;
                        has_down = false;
                        return;
                    }
                });

            /*var tmp_list = searh_layer[name].split("id_anchor");
            var popover_content= tmp_list[0]+"popover_"+id+tmp_list[1];*/
        }
    });

    jsPlumb.bind('click', function (conn, originalEvent) {
        jsPlumb.deleteConnection(conn);

    });

</script>
<script>
    $(document).ready(function () {

        //根据解析页面传参

        var query_object = getQueryObject(window.location.href);
        if (query_object.hasOwnProperty("id")) {
            var net_id = query_object["id"];
            $.ajax({
                type: 'GET',
                url: gobalConfig.base_url + 'api/NeuralNetwork/network/' + net_id + '/',
                beforeSend: function (XMLHttpRequest) {
                    var token = window.sessionStorage.getItem('token');
                    if (token != null) {
                        XMLHttpRequest.setRequestHeader("Authorization", "JWT " + token);
                    }
                },
                success: function (net_work) {
                    var name = net_work["name"];
                    var structure = eval('(' + net_work["structure"] + ')');
                    var nets = structure['nets'];
                    var nets_conn = structure['nets_conn'];
                    var static_val = structure['static'];
                    var drop_function = $("#canvas").droppable('option', 'drop');
                    var event;
                    $("#model_name").text(name);
                    jQuery.each(nets, function (id, val) {

                        jsPlumb.ready(function () {
                            var ui = {
                                'offset': {
                                    'left': parseInt(val['left'].split('px')) * 0.6 + $("#canvas").offset().left + 10,
                                    'top': parseInt(val['top'].split('px')) * 0.5 + $("#canvas").offset().top + 10
                                },
                                'draggable': [{
                                    "id": val['name'],
                                    "innerHTML": $("#" + val['name'])[0].innerHTML
                                }],
                                'id': id
                            };
                            drop_function(event, ui);
                        });
                        window.sessionStorage.setItem(id, JSON.stringify(val['attribute']));
                    });
                    jQuery.each(nets_conn, function (id, val) {
                        jsPlumb.ready(function () {
                            jsPlumb.connect({
                                "source": val['source']['id'],
                                "target": val['target']['id'],
                                "anchors": [val['source']['anchor_position'], val['target']['anchor_position']],
                                "endpoint": ["Dot", {radius: 1}],
                                "paintStyle": {
                                    stroke: "#cccccc",
                                    strokeWidth: 3,

                                },
                                "maxConnections": -1,
                                "connector": ["Flowchart", {
                                    stub: [40, 60],
                                    gap: 5,
                                    cornerRadius: 5,
                                    alwaysRespectStubs: true
                                }],
                                "overlays": [["Arrow", {width: 10, length: 10, location: 1}]],
                                "connectionsDetachable": true,
                            })
                        });
                    });
                    $("#epoch").val(static_val['epoch']);
                    $("#optimzier").find("[value = \"" + static_val['optimizer'] + "\"]").attr("selected", "selected");
                    $('#learning_rate').val(static_val['learning_rate']);
                    $('#batch_size').val(static_val['batch_size'])
                }
            });

        }
        $.ajax({
            type: 'POST',
            data: "{\"name\":\"index\"}",
            url: gobalConfig.base_url + 'api/journal/visit/',
            contentType: 'application/json; charset=UTF-8',
            beforeSend: function (XMLHttpRequest) {
                var token = window.sessionStorage.getItem('token');
                if (token != null) {
                    XMLHttpRequest.setRequestHeader("Authorization", "JWT " + token)
                }
            },
        })

    });
</script>

<script>
    function open_save() {
        $("#save_modal").modal('show');
        var object = getQueryObject(window.location.href);
        if (object.hasOwnProperty("name")) {
            $("#model_name").val(object["name"]);
        }
    }
</script>

<script>
    function show_form(id, name) {

        $("#parameters").children().remove();
        if(no_popover.includes(name)){
            //$("#parameters").append("<a href='javascript:void(0);' onclick='delete_layer(\"" + id + "\")' class='button button-caution button-rounded'>删除该模块</a>");
            return;
        }
        $("#parameters").append(get_content(name, id));
        //$("#parameters").append("<a href='javascript:void(0);' onclick='delete_layer(\"" + id + "\")' class='button button-caution button-rounded'>删除该模块</a>");

        if (name == "conv1d_layer") {
            var data = eval('(' + window.sessionStorage.getItem(id) + ')');
            $("#" + id + "activity").find("[value = \"" + data["activity"] + "\"]").attr("selected", "selected");
            $("#" + id + "pool_way").find("[value = \"" + data["pool_way"] + "\"]").attr("selected", "selected");
        }
        if (name == "conv2d_layer") {
            var data = eval('(' + window.sessionStorage.getItem(id) + ')');
            $("#" + id + "activity").find("[value = \"" + data["activity"] + "\"]").attr("selected", "selected");
            $("#" + id + "pool_way").find("[value = \"" + data["pool_way"] + "\"]").attr("selected", "selected");
        }
        $("[name='pool_way']").bind('change', function () {
            if ($(this).val() == 'None') {
                $(this).parent().parent().find("[name='pool_kernel_size']").attr("disabled", true);
                $(this).parent().parent().find("[name='pool_stride']").attr("disabled", true);
                $(this).parent().parent().find("[name='pool_padding']").attr("disabled", true);
            }
            else {
                $(this).parent().parent().find("[name='pool_kernel_size']").removeAttr("disabled");
                $(this).parent().parent().find("[name='pool_stride']").removeAttr("disabled");
                $(this).parent().parent().find("[name='pool_padding']").removeAttr("disabled");
            }
        });

        $("input").attr("disabled", "disabled");
        $("select").attr("disabled", "disabled");

        $("#parameters").find("input,select").change(function () {
            switch ($("#form" + id).attr("name")) {
                case "view_layer":
                    save_attr_view_layer_form(id);
                    break;
                case "concatenate_layer":
                    save_attr_concatenate_layer_form(id);
                    break;
                case "linear_layer":
                    save_attr_linear_layer_form(id);
                    break;
                case "conv1d_layer":
                    save_attr_conv1d_layer_form(id);
                    break;
                case "conv2d_layer":
                    save_attr_conv2d_layer_from(id);
                    break;
                default:
                    return;
            }
        })
    }
</script>

<script>
    function delete_layer(layer_id) {
        jsPlumb.ready(function () {
            jsPlumb.removeAllEndpoints($("#" + layer_id).attr("id"));
            $("#" + layer_id).remove();
        });
        $("#parameters").children().remove();
    }
</script>

<script>
    $(document).ready(function () {
        var query_object = getQueryObject(window.location.href);
        if (query_object.hasOwnProperty("id")) {
            var net_id = query_object["id"];
        }
        $("#modify").attr("onclick", "open_model("+net_id+")");
        $("input").attr("disabled", "disabled");
        $("select").attr("disabled", "disabled");
    });
</script>

<script>
    function open_model(id) {
        window.location.href="canvas.html?id="+id;
    }
</script>
</html>